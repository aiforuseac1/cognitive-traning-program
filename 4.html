<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>颜色匹配挑战</title>
  <style>
    @import url('https://fonts.googleapis.comcom/css2?family=Orbitron:wght@400;700;900&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { height:100%; }

    :root {
      --ease-out-cubic: cubic-bezier(0.22, 0.61, 0.36, 1);
      --ease-back-out: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body {
      font-family: 'Orbitron', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      -webkit-tap-highlight-color: transparent;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; } 25% { background-position: 100% 50%; }
      50% { background-position: 100% 100%; } 75% { background-position: 0% 100%; }
    }

    .floating-particles {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
    }
    .particle {
      position: absolute; width: 6px; height: 6px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%; animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 0.5; }
    }

    .ui-container {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: opacity 0.4s var(--ease-out-cubic), transform 0.4s var(--ease-out-cubic);
      z-index: 10;
    }
    .ui-container::before {
      content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      border-radius: 27px; z-index: -1; animation: borderGlow 3s ease-in-out infinite alternate;
    }
    @keyframes borderGlow {
      from { opacity: 0.5; transform: scale(1); } to { opacity: 1; transform: scale(1.02); }
    }
    .ui-container.hidden {
      opacity: 0; pointer-events: none; transform: scale(0.95) translateY(10px);
    }
    
    .control-panel {
        padding: 30px 40px;
        display:flex; gap: 20px; align-items:center; flex-direction: column;
    }
    .control-panel .form-group { display: flex; align-items: center; gap: 15px; width: 100%; justify-content: space-between; }
    .control-panel label { font-weight: 700; color:white; font-size: 16px; text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    .control-panel select, .control-panel input[type="number"] {
        padding:10px 14px; border:1px solid rgba(255, 255, 255, 0.2); border-radius:8px;
        width:150px; font-size:16px; text-align:center;
        background: rgba(0, 0, 0, 0.2); color:white;
        transition: all 0.25s ease;
        font-family: 'Orbitron', sans-serif;
    }
    .control-panel select:focus, .control-panel input[type="number"]:focus {
        outline: none; border-color: #4ecdc4; box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
    }
    .btn {
        background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 28px;
        border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer;
        transition: all 0.3s ease; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        position: relative; overflow: hidden; display: inline-flex; align-items: center; justify-content: center;
        font-family: 'Orbitron', sans-serif;
    }
    .btn::before {
        content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    .btn:hover:not(.disabled) { transform: translateY(-3px); }
    .btn:hover:not(.disabled)::before { left: 100%; }

    #startBtn { margin-top: 15px; background: linear-gradient(45deg,#ff6b6b,#f0932b); box-shadow:0 8px 16px rgba(238,90,36,0.4); }
    #startBtn:hover { box-shadow:0 12px 24px rgba(238,90,36,0.6); }

    #gameScreen {
      width: 100vw; height: 100vh; max-width: 100%; max-height: 100%;
      border-radius: 0; border: none; backdrop-filter: none; background: transparent;
      box-shadow: none;
      display: flex; flex-direction: column; justify-content: space-between; align-items: center;
    }
    #gameScreen::before { display: none; }

    .timer-container { width: 100%; padding: 20px; position: absolute; top: 0; z-index: 120; }
    .timer-bar {
      max-width: 500px; margin: 0 auto;
      height: 10px; background-color: rgba(0,0,0,0.3);
      border-radius: 5px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    }
    .timer-fill {
      height: 100%; width: 100%;
      background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
      border-radius: 5px; position: relative; overflow: hidden;
    }
    .timer-fill::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
      transform: translateX(-100%); animation: sheen 1.5s infinite;
    }
    @keyframes sheen { to { transform: translateX(100%); } }

    .game-area {
      width: 100%; flex-grow: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 5vh; padding: 20px;
    }

    .color-word{
      font-size: clamp(80px, 25vmin, 200px); font-weight:900; user-select:none;
      text-shadow: 0 0 15px rgba(0,0,0,0.5);
      filter: drop-shadow(0 12px 35px rgba(0,0,0,0.15));
      opacity: 0;
    }
    .color-word.anim-enter { animation: word-enter 0.5s var(--ease-back-out) forwards; }
    @keyframes word-enter {
        from { transform: scale(0.6) translateY(-20px) rotate(-5deg); opacity: 0; }
        to { transform: scale(1) translateY(0) rotate(0deg); opacity: 1; }
    }
    .color-word.correct-feedback { animation: correct-pulse 0.4s ease; }
    @keyframes correct-pulse { 50% { transform: scale(1.1); } }
    .color-word.incorrect-feedback { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-4px)} 40%,60%{transform:translateX(4px)} }

    .choice-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .choice-btn {
      padding: 14px 30px; font-size: 20px;
      opacity: 0; transform: translateY(30px);
      background: linear-gradient(135deg, #ff9500, #ff6b00);
      box-shadow: 0 8px 16px rgba(255, 149, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    .choice-btn.anim-enter { animation: button-enter 0.5s var(--ease-out-cubic) forwards; }
    @keyframes button-enter { to { opacity: 1; transform: translateY(0); } }
    
    .choice-btn:hover { box-shadow: 0 12px 24px rgba(255, 149, 0, 0.6); }
    .choice-btn.disabled { pointer-events: none; opacity: 0.6 !important; background: linear-gradient(135deg, #bdc3c7, #95a5a6) !important; box-shadow: 0 4px 8px rgba(189,195,199,0.4) !important; }
    .choice-btn.correct-choice { background: linear-gradient(135deg, #2ed573, #20bf6b) !important; animation: correct-choice-anim 0.5s ease forwards; }
    @keyframes correct-choice-anim { 50% { transform: scale(1.1); } }
    .choice-btn.incorrect-choice { background: linear-gradient(135deg, #ff4757, #e84118) !important; animation: incorrect-choice-anim 0.5s ease forwards; }
    @keyframes incorrect-choice-anim { 50% { transform: translateY(2px); } }

    #stopBtn {
      position: absolute; top: 20px; right: 20px;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(5px);
      padding: 8px 16px; font-size: 14px; z-index: 130;
    }
    #stopBtn:hover { background: rgba(0,0,0,0.5); }
    
    .progress-wrapper {
      background: rgba(0,0,0,0.22); padding: 10px 20px; border-radius:15px;
      backdrop-filter: blur(5px); text-align: center; color: white; user-select:none;
      position: relative;
    }
    #scoreDisplay { font-weight: 700; }
    #scoreDisplay.anim-update { animation: score-update 0.4s var(--ease-back-out); }
    @keyframes score-update { 50% { transform: scale(1.25); } }
    .progress-bar{ width:320px; height:8px; background: rgba(0,0,0,0.3); border-radius:4px; overflow:hidden; }
    .progress-fill{ height:100%; width:0%; border-radius:4px; background: #fff; transition: width .4s var(--ease-out-cubic); }
    .score-popup {
      position: absolute; top: -20px; left: 50%; font-size: 18px; font-weight: bold; color: #2ed573;
      animation: score-popup-anim 0.8s ease-out forwards; pointer-events: none;
    }
    @keyframes score-popup-anim { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -40px); } }

    .completion-message {
        padding:25px; text-align:center;
        display:flex; gap:12px; flex-direction:column; min-width:320px;
    }
    .completion-message .score-text { font-size: 18px; color: rgba(255,255,255,0.8); }
    .completion-emoji{ font-size:40px; }
    .completion-message #completionTitle { font-size: 24px; font-weight: 900; }

    #analysisReport {
      max-width: 540px; width: 90vw; padding: 25px; max-height: 85vh;
      overflow-y: auto; text-align: left;
    }
    #analysisReport.visible .anim-item { animation: item-fade-in 0.6s var(--ease-out-cubic) forwards; opacity: 0; }
    @keyframes item-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .report-header { text-align: center; margin-bottom: 20px; }
    .report-header h3 { font-size: 26px; color: #4ecdc4; }
    .report-header p { font-size: 16px; color: rgba(255,255,255,0.8); margin-top: 5px; }

    .metrics-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .metric-item {
      flex: 1; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; text-align: center;
    }
    .metric-item .label { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 8px; }
    .metric-item .value { font-size: 22px; font-weight: bold; color: #4ecdc4; }
    .metric-item .unit { font-size: 14px; margin-left: 2px; }

    .report-section { margin-top: 20px; }
    .report-section h4 {
      display: flex; align-items: center; gap: 10px;
      font-size: 18px; color: white; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .report-section h4::before {
      content: ''; display: block; width: 24px; height: 24px;
      background-size: contain; background-repeat: no-repeat;
    }
    h4#brain-title::before { filter: invert(1); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23764ba2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9.5 2A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 9.5 7v0A2.5 2.5 0 0 1 7 4.5v0A2.5 2.5 0 0 1 9.5 2Z'/%3E%3Cpath d='M14.5 2A2.5 2.5 0 0 1 17 4.5v0A2.5 2.5 0 0 1 14.5 7v0A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 14.5 2Z'/%3E%3Cpath d='M12 17.5A2.5 2.5 0 0 1 9.5 15v0A2.5 2.5 0 0 1 12 12.5v0A2.5 2.5 0 0 1 14.5 15v0A2.5 2.5 0 0 1 12 17.5Z'/%3E%3Cpath d='M4.5 12A2.5 2.5 0 0 1 7 9.5v0A2.5 2.5 0 0 1 9.5 7v0'/%3E%3Cpath d='M19.5 12A2.5 2.5 0 0 0 17 9.5v0A2.5 2.5 0 0 0 14.5 7v0'/%3E%3Cpath d='M2 9.5A2.5 2.5 0 0 1 4.5 7v0'/%3E%3Cpath d='M22 9.5A2.5 2.5 0 0 0 19.5 7v0'/%3E%3Cpath d='M7 19.5A2.5 2.5 0 0 1 4.5 17v0A2.5 2.5 0 0 1 7 14.5v0'/%3E%3Cpath d='M17 19.5A2.5 2.5 0 0 0 19.5 17v0A2.5 2.5 0 0 0 17 14.5v0'/%3E%3Cpath d='M12 22a2.5 2.5 0 0 1-2.5-2.5v0'/%3E%3Cpath d='M12 22a2.5 2.5 0 0 0 2.5-2.5v0'/%3E%3C/svg%3E"); }
    h4#life-title::before { filter: invert(1); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232ed573' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10c0 1.5-1 3-2 3s-2-1.5-2-3-1-2.5-2.5-2.5S13 10.5 13 12s.5 1.5 1.5 1.5S16 12 16 13.5s-1 2.5-2.5 2.5S11 15 11 16.5s.5 1.5 1.5 1.5c.7 0 1.3-.3 1.7-.7'/%3E%3Cpath d='M12 22v-2.5'/%3E%3C/svg%3E"); }
    .report-section ul { list-style: none; padding-left: 5px; }
    .report-section li { margin-bottom: 10px; padding-left: 24px; position: relative; font-size: 15px; color: rgba(255,255,255,0.9); line-height: 1.6; }
    .report-section li::before { content: '›'; position: absolute; left: 0; top: 0; color: #4ecdc4; font-weight: bold; font-size: 20px; line-height: 1.1; }
    .report-section li b { color: white; }
    
    #playAgainBtn {
        margin: 25px auto 0;
        background: linear-gradient(135deg, #2ed573, #20bf6b);
        box-shadow: 0 8px 16px rgba(46, 213, 115, 0.4);
        display: block;
    }
    #playAgainBtn:hover { box-shadow: 0 12px 24px rgba(46, 213, 115, 0.6); }

    #feedbackFlash { position: fixed; inset: 0; z-index: 210; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
    #feedbackFlash.correct-flash { background: radial-gradient(circle, rgba(46, 213, 115, 0.25) 0%, rgba(46, 213, 115, 0) 70%); }
    #feedbackFlash.incorrect-flash { background: radial-gradient(circle, rgba(255, 71, 87, 0.25) 0%, rgba(255, 71, 87, 0) 70%); }
    #feedbackFlash.active { opacity: 1; transition: opacity 0.05s ease; }
    
    .fragment-canvas { position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:9; }

    @media (max-width:480px){ .progress-bar{ width:260px; } .choice-btn { font-size: 18px; padding: 10px 20px; } .metrics-container { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="floating-particles" id="particles"></div>

  <div class="control-panel ui-container" id="controlPanel">
    <div class="form-group">
      <label for="difficultySelect">难度：</label>
      <select id="difficultySelect" aria-label="选择难度">
        <option value="easy">简单 (无计时)</option>
        <option value="medium" selected>中等 (5秒)</option>
        <option value="hard">困难 (3秒)</option>
      </select>
    </div>
    <div class="form-group">
      <label for="totalCount">题数：</label>
      <input type="number" id="totalCount" value="10" min="1" max="100" />
    </div>
    <button class="btn" id="startBtn">开始挑战</button>
  </div>

  <div id="gameScreen" class="ui-container hidden">
      <div class="timer-container">
          <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
      </div>
      <button class="btn" id="stopBtn">终止</button>
      <div class="game-area">
          <div class="color-word" id="colorWord" aria-live="polite"></div>
          <div id="choiceContainer" class="choice-container"></div>
      </div>
      <div class="progress-container">
        <div class="progress-wrapper" id="progressWrapper">
            <div id="scoreDisplay" class="progress-text">得分: 0</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
      </div>
      <canvas class="fragment-canvas" id="fragmentCanvas"></canvas>
  </div>

  <div class="completion-message ui-container hidden" id="completionMessage">
    <div class="completion-emoji">🎉</div>
    <div id="completionTitle">挑战完成!</div>
    <div id="completionScore" class="score-text"></div>
  </div>

  <div class="completion-message ui-container hidden" id="analysisReport">
      <div class="report-header anim-item">
          <h3 id="reportTitle"></h3>
          <p id="reportSummary"></p>
      </div>
      <div class="metrics-container anim-item" style="animation-delay: 0.1s;">
          <div class="metric-item">
              <div class="label">最终得分</div>
              <div class="value" id="reportScore"></div>
          </div>
          <div class="metric-item">
              <div class="label">平均反应</div>
              <div class="value"><span id="reportAvgTime"></span><span class="unit">秒</span></div>
          </div>
          <div class="metric-item">
              <div class="label">准确率</div>
              <div class="value"><span id="reportAccuracy"></span><span class="unit">%</span></div>
          </div>
      </div>
      <div class="report-section anim-item" style="animation-delay: 0.2s;">
          <h4 id="brain-title">认知能力分析</h4>
          <ul id="reportBrainTip"></ul>
      </div>
      <div class="report-section anim-item" style="animation-delay: 0.3s;">
          <h4 id="life-title">个性化生活建议</h4>
          <ul id="reportLifeTip"></ul>
      </div>
      <button class="btn" id="playAgainBtn" class="anim-item" style="animation-delay: 0.4s;">再玩一次</button>
  </div>


  <div id="feedbackFlash"></div>
  
<script>
document.addEventListener('DOMContentLoaded', () => {
    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer || particlesContainer.children.length > 0) return;
        const particleCount = 50;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 6}s`;
            particle.style.animationDuration = `${Math.random() * 4 + 4}s`;
            particlesContainer.appendChild(particle);
        }
    }
    createParticles();

    // --- All of your original JavaScript code is preserved below ---
    const COLORS_DATA = { '红':'#ff0000', '橙':'#ff8800', '黄':'#ffff00', '绿':'#00ff00', '蓝':'#0000ff', '紫':'#8800ff', '黑':'#000000', '白':'#ffffff' };
    const COLOR_NAMES = Object.keys(COLORS_DATA);
    const DIFFICULTY_SETTINGS = {
        easy:   { time: Infinity, choices: 4 },
        medium: { time: 5000, choices: 4 },
        hard:   { time: 3000, choices: 6 }
    };

    const elements = {
      controlPanel: document.getElementById('controlPanel'), gameScreen: document.getElementById('gameScreen'),
      difficultySelect: document.getElementById('difficultySelect'), totalCountInput: document.getElementById('totalCount'),
      startBtn: document.getElementById('startBtn'), stopBtn: document.getElementById('stopBtn'),
      timerFill: document.getElementById('timerFill'), colorWord: document.getElementById('colorWord'),
      choiceContainer: document.getElementById('choiceContainer'), 
      progressWrapper: document.getElementById('progressWrapper'), scoreDisplay: document.getElementById('scoreDisplay'),
      progressFill: document.getElementById('progressFill'), completionMessage: document.getElementById('completionMessage'),
      completionTitle: document.getElementById('completionTitle'), completionScore: document.getElementById('completionScore'),
      effectsLayer: document.getElementById('effectsLayer'), feedbackFlash: document.getElementById('feedbackFlash'),
      analysisReport: document.getElementById('analysisReport'), playAgainBtn: document.getElementById('playAgainBtn'),
      reportTitle: document.getElementById('reportTitle'), reportScore: document.getElementById('reportScore'),
      reportAvgTime: document.getElementById('reportAvgTime'), reportAccuracy: document.getElementById('reportAccuracy'),
      reportSummary: document.getElementById('reportSummary'),
      reportBrainTip: document.getElementById('reportBrainTip'), reportLifeTip: document.getElementById('reportLifeTip'),
      fragmentCanvas: document.getElementById('fragmentCanvas')
    };
    
    const ctx = elements.fragmentCanvas.getContext('2d');
    let gameState = {};

    function resetGameState() {
        gameState = {
            isRunning: false, difficulty: 'medium', totalCount: 10, currentCount: 0, score: 0,
            correctAnswer: '', timerId: null, roundStartTime: 0,
            correctCount: 0, reactionTimes: []
        };
    }
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const shuffleArray = (arr) => arr.sort(() => Math.random() - 0.5);

    function switchScreen(from, to) {
      from.classList.add('hidden');
      if (from.id === 'analysisReport') from.classList.remove('visible');
      
      setTimeout(() => { 
        to.classList.remove('hidden'); 
        if (to.id === 'analysisReport') {
            requestAnimationFrame(() => to.classList.add('visible'));
        }
      }, 400);
    }

    function startGame() {
      if (gameState.isRunning) return;
      resetGameState();
      gameState.isRunning = true;
      gameState.difficulty = elements.difficultySelect.value;
      gameState.totalCount = Math.max(1, parseInt(elements.totalCountInput.value) || 10);
      switchScreen(elements.controlPanel, elements.gameScreen);
      updateProgress(0);
      setTimeout(nextRound, 500);
    }

    function stopGame() {
        if (!gameState.isRunning) return;
        gameState.isRunning = false;
        clearTimeout(gameState.timerId);
        switchScreen(elements.gameScreen, elements.controlPanel);
        resetGameState();
    }

    function nextRound() {
      if (!gameState.isRunning) return;
      if (gameState.currentCount >= gameState.totalCount) {
        endGame(); return;
      }
      clearForNextRound();
      let wordIndex, colorIndex;
      do { wordIndex = randInt(0, COLOR_NAMES.length - 1); colorIndex = randInt(0, COLOR_NAMES.length - 1); } while (wordIndex === colorIndex);
      
      const currentWord = COLOR_NAMES[wordIndex];
      const currentColor = COLORS_DATA[COLOR_NAMES[colorIndex]];
      gameState.correctAnswer = COLOR_NAMES[colorIndex];
      
      elements.colorWord.textContent = currentWord;
      elements.colorWord.style.color = currentColor;
      elements.colorWord.style.textShadow = (currentColor === '#ffffff' || currentColor === '#ffff00') ? '0 0 5px rgba(0,0,0,0.8)' : 'none';
      elements.colorWord.classList.add('anim-enter');

      const choices = generateChoices(gameState.correctAnswer, DIFFICULTY_SETTINGS[gameState.difficulty].choices);
      choices.forEach((choiceText, index) => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn btn'; // Add .btn class
          btn.textContent = choiceText;
          btn.onclick = (e) => handleChoice(e.target);
          elements.choiceContainer.appendChild(btn);
          btn.style.animationDelay = `${index * 80}ms`;
          btn.classList.add('anim-enter');
      });
      startTimer();
    }
    
    function handleChoice(buttonElement) {
        if (!gameState.isRunning || buttonElement.classList.contains('disabled')) return;
        clearTimeout(gameState.timerId);
        document.querySelectorAll('.choice-btn').forEach(b => b.classList.add('disabled'));

        gameState.currentCount++;
        const selectedAnswer = buttonElement.textContent;
        let isCorrect = selectedAnswer === gameState.correctAnswer;
        let pointsAdded = 0;

        if (isCorrect) {
            gameState.correctCount++;
            const timeTaken = performance.now() - gameState.roundStartTime;
            const timeLimit = DIFFICULTY_SETTINGS[gameState.difficulty].time;
            
            let basePoints = 100;
            let timeBonus = 0;

            if(timeLimit !== Infinity) {
                gameState.reactionTimes.push(timeTaken);
                timeBonus = Math.max(0, Math.floor((1 - timeTaken / timeLimit) * 50));
            }
            pointsAdded = basePoints + timeBonus;
            gameState.score += pointsAdded;

            elements.colorWord.classList.add('correct-feedback');
            buttonElement.classList.add('correct-choice');
            triggerFeedbackFlash(true);
            triggerFragments(COLORS_DATA[gameState.correctAnswer]);
        } else {
            elements.colorWord.classList.add('incorrect-feedback');
            buttonElement.classList.add('incorrect-choice');
            triggerFeedbackFlash(false);
        }

        updateProgress(pointsAdded);
        setTimeout(nextRound, 800);
    }

    function endGame() {
        gameState.isRunning = false;
        elements.completionTitle.textContent = "挑战完成!";
        elements.completionScore.textContent = `最终得分: ${gameState.score}`;
        switchScreen(elements.gameScreen, elements.completionMessage);
        spawnCompletionParticles();
        setTimeout(showAnalysisReport, 2500);
    }
    
    function getStandardDeviation(array) {
        if (array.length < 2) return 0;
        const n = array.length;
        const mean = array.reduce((a, b) => a + b) / n;
        const variance = array.reduce((a, b) => a + (b - mean) ** 2, 0) / (n - 1);
        return Math.sqrt(variance);
    }

    function generateAnalysisReport(gs) {
      const accuracy = gs.totalCount > 0 ? gs.correctCount / gs.totalCount : 0;
      const hasReactionTime = gs.reactionTimes.length > 0;
      const avgReactionTime = hasReactionTime ? gs.reactionTimes.reduce((a, b) => a + b, 0) / gs.reactionTimes.length : 0;
      const reactionTimeStdDev = hasReactionTime ? getStandardDeviation(gs.reactionTimes) : 0;
      let trend = 'stable';
      if (gs.reactionTimes.length >= 6) {
          const half = Math.ceil(gs.reactionTimes.length / 2);
          const firstHalfAvg = gs.reactionTimes.slice(0, half).reduce((a,b) => a+b,0) / half;
          const secondHalfAvg = gs.reactionTimes.slice(-half).reduce((a,b) => a+b,0) / half;
          if (secondHalfAvg < firstHalfAvg * 0.9) trend = 'improving';
          if (secondHalfAvg > firstHalfAvg * 1.1) trend = 'fatiguing';
      }
      let title, summary; let brainTips = []; let lifeTips = [];
      if (accuracy >= 0.9 && (!hasReactionTime || avgReactionTime < 1500)) {
          title = "认知大师 🏆"; summary = "您展现了卓越的专注力和信息处理速度，表现近乎完美！";
      } else if (accuracy >= 0.8) {
          title = "专注思考者 🎯"; summary = "您在准确性和速度之间取得了出色的平衡，抗干扰能力很强。";
      } else {
          title = "潜力新星 ✨"; summary = "这是一个很棒的开始！每次练习都是对大脑的宝贵锻炼。";
      }
      if (accuracy > 0.9) brainTips.push("<b>抑制控制极佳：</b>您能精准地忽略文字的干扰，专注于颜色信息，这是高度自律和专注的体现。");
      else if (accuracy > 0.7) brainTips.push("<b>抑制控制良好：</b>您拥有可靠的专注力，能够有效对抗大部分来自大脑“阅读本能”的干扰。");
      else brainTips.push("<b>抑制控制锻炼中：</b>这个挑战对您的大脑是一次很好的“专注力锻炼”，能有效提升抗干扰能力。");
      if (hasReactionTime) {
        if (avgReactionTime < 1500) brainTips.push("<b>处理速度飞快：</b>您的大脑能以极高的效率处理并解决认知冲突，反应敏捷。");
        else if (avgReactionTime < 2500) brainTips.push("<b>处理速度稳健：</b>您在思考和行动间找到了一个理想的平衡点，决策又快又准。");
        else brainTips.push("<b>决策风格审慎：</b>您倾向于用更充分的时间来确保判断的准确性，这是一种可靠的策略。");
        if (reactionTimeStdDev < 350) brainTips.push("<b>认知稳定性高：</b>您的反应时间非常一致，表明您在整个挑战中保持了持续、稳定的专注力。");
        else brainTips.push("<b>认知状态有波动：</b>您的反应时间有起伏，这很正常，可能反映了精力集中与稍事思考的自然交替。");
        if (trend === 'improving') brainTips.push("<b>适应能力强：</b>数据显示您越玩越快，证明您的大脑在挑战中迅速学习和适应，非常棒！");
        else if (trend === 'fatiguing') brainTips.push("<b>出现认知疲劳：</b>数据显示您在后半段反应略有变慢，这是大脑高强度工作后的正常现象。");
      } else { brainTips.push("<b>从容不迫：</b>您在无计时模式下挑战，展现了沉着冷静的心态和对准确性的重视。"); }
      if (accuracy < 0.8) lifeTips.push("尝试5分钟的<b>正念冥想</b>，可以有效提升您的持续专注力和抑制冲动的能力。");
      else lifeTips.push("您强大的专注力在工作学习中是巨大优势，能帮您在复杂环境中保持高效。");
      if (hasReactionTime && reactionTimeStdDev > 400) lifeTips.push("可以试试<b>“番茄工作法”</b>（工作25分钟，休息5分钟），帮助您在任务中保持更稳定的精力水平。");
      if (hasReactionTime && trend === 'fatiguing') lifeTips.push("请记住，<b>高质量的睡眠和短暂的课间/工间休息</b>是恢复大脑活力的最佳方式。");
      else lifeTips.push("保持学习新技能或进行体育锻炼的习惯，能持续增强您大脑的认知灵活性和处理速度。");
      return { title, summary, brainTips, lifeTips, score: gs.score, accuracy, avgReactionTime };
    }

    function showAnalysisReport() {
      const report = generateAnalysisReport(gameState);
      elements.reportTitle.textContent = report.title;
      elements.reportSummary.textContent = report.summary;
      elements.reportScore.textContent = report.score;
      elements.reportAvgTime.textContent = report.avgReactionTime > 0 ? (report.avgReactionTime / 1000).toFixed(2) : 'N/A';
      elements.reportAccuracy.textContent = (report.accuracy * 100).toFixed(0);
      elements.reportBrainTip.innerHTML = report.brainTips.map(tip => `<li>${tip}</li>`).join('');
      elements.reportLifeTip.innerHTML = report.lifeTips.map(tip => `<li>${tip}</li>`).join('');
      switchScreen(elements.completionMessage, elements.analysisReport);
    }

    function clearForNextRound() {
        elements.choiceContainer.innerHTML = '';
        elements.colorWord.className = 'color-word';
        clearTimeout(gameState.timerId);
    }

    function generateChoices(correctAnswer, numChoices) {
        let choices = new Set([correctAnswer]);
        while(choices.size < numChoices) choices.add(COLOR_NAMES[randInt(0, COLOR_NAMES.length - 1)]);
        return shuffleArray(Array.from(choices));
    }
    
    function startTimer() {
        const timeLimit = DIFFICULTY_SETTINGS[gameState.difficulty].time;
        if (timeLimit === Infinity) { elements.timerFill.style.width = '100%'; return; }

        gameState.roundStartTime = performance.now();
        elements.timerFill.style.transition = 'none';
        elements.timerFill.style.width = '100%';
        
        requestAnimationFrame(() => {
          setTimeout(() => {
              elements.timerFill.style.transition = `width ${timeLimit / 1000}s linear`;
              elements.timerFill.style.width = '0%';
          }, 0);
        });

        gameState.timerId = setTimeout(() => {
            const fakeBtn = { textContent: null, classList: { contains:()=>false, add:()=>{} } };
            handleChoice(fakeBtn);
        }, timeLimit);
    }

    function updateProgress(points) {
      elements.scoreDisplay.textContent = `得分: ${gameState.score}`;
      elements.scoreDisplay.classList.remove('anim-update');
      void elements.scoreDisplay.offsetWidth;
      elements.scoreDisplay.classList.add('anim-update');

      if (points > 0) {
          const popup = document.createElement('div');
          popup.className = 'score-popup';
          popup.textContent = `+${points}`;
          elements.progressWrapper.appendChild(popup);
          setTimeout(() => popup.remove(), 800);
      }
      
      const pct = gameState.totalCount > 0 ? (gameState.currentCount / gameState.totalCount) * 100 : 0;
      elements.progressFill.style.width = pct + '%';
    }

    function triggerFeedbackFlash(isCorrect) {
        const flash = elements.feedbackFlash;
        flash.className = isCorrect ? 'correct-flash' : 'incorrect-flash';
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 150);
    }

    function triggerFragments(hexColor){
      if(!ctx) return;
      elements.fragmentCanvas.width=window.innerWidth;
      elements.fragmentCanvas.height=window.innerHeight;
      const rect=elements.fragmentCanvas.getBoundingClientRect(),
      cwRect=elements.colorWord.getBoundingClientRect();
      if(cwRect.width===0)return;
      const cx=cwRect.left+cwRect.width/2-rect.left, cy=cwRect.top+cwRect.height/2-rect.top;
      let fragments=[];
      for(let i=0;i<16;i++){
        fragments.push({ x:cx, y:cy, vx:(Math.random()-.5)*4, vy:(Math.random()-.5)*4, size:2+Math.random()*4, life:0, maxLife:60+Math.random()*60, color:hexColor })
      }
      animateFragments(fragments);
    }
    
    function animateFragments(fragments){
      function frame(){
        ctx.clearRect(0,0,elements.fragmentCanvas.width,elements.fragmentCanvas.height);
        for(let i=fragments.length-1;i>=0;i--){
          const f=fragments[i];
          f.x+=f.vx; f.y+=f.vy; f.vy+=.05; f.life++;
          if(f.life>=f.maxLife){ fragments.splice(i,1); continue; }
          const p=f.life/f.maxLife;
          ctx.globalAlpha=1-p; ctx.fillStyle=f.color; ctx.fillRect(f.x,f.y,f.size,f.size);
        }
        if(fragments.length>0) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function spawnCompletionParticles() { /* original function was empty, left empty */ }

    elements.startBtn.addEventListener('click', startGame);
    elements.stopBtn.addEventListener('click', stopGame);
    elements.playAgainBtn.addEventListener('click', () => {
        switchScreen(elements.analysisReport, elements.controlPanel);
    });
    
    resetGameState();
});
</script>
</body>
</html>