<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§è®¤çŸ¥åŠŸèƒ½è®­ç»ƒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --glow-color: #4ecdc4;
            --primary-accent: #879aff;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --bg-dark-alpha: rgba(0,0,0,0.1);
            --bg-darker-alpha: rgba(0,0,0,0.2);
            --border-alpha: rgba(255,255,255,0.1);
            --text-primary: white;
            --text-secondary: rgba(255,255,255,0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            color: var(--text-primary);
        }

        @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 25% { background-position: 100% 50%; } 50% { background-position: 100% 100%; } 75% { background-position: 0% 100%; } }

        .floating-particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .particle { position: absolute; width: 6px; height: 6px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; } 50% { transform: translateY(-20px) rotate(180deg); opacity: 0.5; } }

        .game-container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 25px; padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2), inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            max-width: 900px; width: 100%; border: 2px solid var(--border-alpha); position: relative; z-index: 2;
            display: flex; flex-direction: column; align-items: center;
        }
        .game-container::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7, #dda0dd);
            border-radius: 27px; z-index: -1; animation: borderGlow 3s ease-in-out infinite alternate;
        }
        @keyframes borderGlow { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 1; transform: scale(1.02); } }
        
        .header { text-align: center; margin-bottom: 25px; }
        .title {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1); background-clip: text; -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: clamp(2rem, 8vw, 2.5rem);
            font-weight: 900; margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); animation: titlePulse 2s ease-in-out infinite alternate;
        }
        @keyframes titlePulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        .header p { font-size: 1.1rem; opacity: 0.9; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }

        .controls {
            padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px;
            align-items: center; justify-content: center; background: var(--bg-dark-alpha); border: 1px solid var(--border-alpha); width: 100%;
        }
        .control-group { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        select, .btn {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px;
            border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; margin: 0 5px;
            transition: all 0.3s ease; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4); font-family: 'Orbitron', monospace;
        }
        select { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 10px; padding-right: 40px;
        }
        .btn:hover, select:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(102, 126, 234, 0.6); }
        .btn:disabled { background: linear-gradient(135deg, #bdc3c7, #95a5a6); cursor: not-allowed; transform: none; }
        
        #showReportBtn { background: linear-gradient(135deg, #ffc107, #ff9800); }
        
        #resetBtn {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            box-shadow: 0 8px 16px rgba(231, 76, 60, 0.4);
        }
        #resetBtn:hover {
            box-shadow: 0 12px 24px rgba(231, 76, 60, 0.6);
        }
        
        .info-icon { background: rgba(255,255,255,0.3); border-radius: 50%; color: white; text-align: center; font-weight: bold; display: inline-block; width: 24px; height: 24px; line-height: 24px; cursor: pointer; transition: all 0.3s ease; }
        .info-icon:hover { transform: scale(1.2) rotate(360deg); }
        
        .game-area { background: var(--bg-dark-alpha); border: 1px solid var(--border-alpha); padding: 20px; border-radius: 20px; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .stats {
            display: none;
            justify-content: space-around;
            align-items: center;
            background: var(--bg-dark-alpha);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .stat-item { text-align: center; }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg,#ff6b6b,#feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { font-size: 14px; color: var(--text-secondary); margin-top: 5px; }
        
        .progress-bar { width: 100%; height: 8px; background: var(--bg-darker-alpha); border-radius: 4px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg,#667eea,#764ba2); transition: width .3s ease; }
        
        #taskInstruction { text-align: center; font-weight: 700; margin-bottom: 15px; padding: 10px; border-radius: 15px; transition: all .3s ease; animation: phaseGlow 2s ease-in-out infinite alternate; text-shadow:0 2px 4px rgba(0,0,0,.3); min-height: 40px; }
        @keyframes phaseGlow { 0%{box-shadow:0 0 20px rgba(255,255,255,.2)} 100%{box-shadow:0 0 30px rgba(255,255,255,.4)} }
        
        .grid { display: grid; gap: 10px; }
        .grid.size-3 { grid-template-columns: repeat(3, 1fr); }
        .grid.size-4 { grid-template-columns: repeat(4, 1fr); }
        .grid.size-5 { grid-template-columns: repeat(5, 1fr); }
        .grid.size-6 { grid-template-columns: repeat(6, 1fr); }
        
        .card {
            aspect-ratio: 1; border: none; border-radius: 15px; font-size: clamp(16px,4vw,32px);
            font-weight: 900; color: var(--text-primary); cursor: pointer;
            transition: all .4s cubic-bezier(.175,.885,.32,1.275); display: flex;
            align-items: center; justify-content: center; user-select: none;
            position: relative; overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.2);
            background: linear-gradient(135deg,#2ecc71,#27ae60);
        }
        .card:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,.5),0 0 20px rgba(255,255,255,.3); }
        .card.no-go { background: linear-gradient(135deg,#ff9500,#ff6b00); }
        .card.hidden .cell-content { opacity: 0; }
        .card.matched { background: linear-gradient(135deg,#9b59b6,#8e44ad); transform: scale(.95); cursor: not-allowed; animation: matchPulse .6s ease-in-out; opacity:.7; }
        @keyframes matchPulse { 0%{transform:scale(.95)} 50%{transform:scale(1.1)} 100%{transform:scale(.95)} }
        .card.error { background: linear-gradient(135deg,#e74c3c,#c0392b); animation: incorrectShake .6s ease-out; }
        @keyframes incorrectShake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
        .message { text-align:center; padding:15px; margin:10px 0; border-radius:10px; font-weight:700; background:var(--bg-darker-alpha); border:1px solid var(--border-alpha); }

        .dashboard {
            background: var(--bg-dark-alpha); border: 1px solid var(--border-alpha);
            padding: 20px; border-radius: 20px; width: 100%; max-width: 860px; margin-top: 20px;
        }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px; }
        .dashboard-header h3 { background: linear-gradient(45deg, var(--warning-color), var(--glow-color)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; font-size: 1.5rem; }
        #clearRecordsBtn { background: linear-gradient(135deg, var(--danger-color), #c0392b); padding: 8px 15px; font-size: 12px; }

        .dashboard-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; background: var(--bg-darker-alpha); padding: 10px; border-radius: 10px; }
        #filterMode { padding: 8px 15px; font-size: 14px; border-radius: 8px; background: rgba(255,255,255,0.1); }

        .dashboard-main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .dashboard-profile, .dashboard-summary { background: var(--bg-darker-alpha); padding: 15px; border-radius: 15px; }
        .dashboard-summary-title, .dashboard-profile-title { text-align: center; margin-bottom: 10px; font-size: 1.1em; color: var(--text-secondary); }
        
        .radar-chart-container { position: relative; width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; }
        .radar-chart { width: 100%; height: 100%; }
        .radar-grid { stroke: rgba(255,255,255,0.2); stroke-width: 1; fill: none; }
        .radar-axis { stroke: rgba(255,255,255,0.3); stroke-width: 1; }
        .radar-area { fill: rgba(78, 205, 196, 0.4); stroke: var(--glow-color); stroke-width: 2; transition: all 0.5s ease; animation: radar-fade-in 1s; }
        .radar-labels { font-size: clamp(8px, 2.5vw, 10px); fill: var(--text-primary); text-anchor: middle; }
        @keyframes radar-fade-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 15px; }
        .summary-item .value { font-size: 1.6rem; font-weight: bold; color: var(--primary-accent); }
        .summary-item .label { font-size: 0.8rem; color: var(--text-secondary); }
        .summary-insight { background: var(--bg-dark-alpha); border-left: 3px solid var(--primary-accent); padding: 10px; border-radius: 5px; text-align: center; font-size: 0.9em; min-height: 40px; display: flex; align-items: center; justify-content: center;}
        
        #trendChartContainer { background: var(--bg-darker-alpha); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .chart-svg { width: 100%; height: 180px; }
        .chart-line{fill:none;stroke:var(--glow-color);stroke-width:3;stroke-linecap:round;stroke-linejoin:round;animation:draw-line 1.5s ease-out forwards}
        .chart-area{fill:url(#chartGradient);opacity:.5;animation:fade-in 1s ease-out forwards}
        .chart-point{fill:var(--warning-color);stroke:rgba(0,0,0,.5);stroke-width:2;transition:r .3s ease}
        .chart-point:hover{r:7}
        .chart-avg-line{stroke:var(--primary-accent);stroke-width:1.5;stroke-dasharray:4,4}
        @keyframes draw-line{from{stroke-dasharray:1000;stroke-dashoffset:1000}to{stroke-dasharray:1000;stroke-dashoffset:0}}
        @keyframes fade-in{from{opacity:0}to{opacity:.5}}

        #recordsList { background: var(--bg-darker-alpha); padding: 5px 15px 15px; border-radius: 15px; }
        .record-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; padding: 12px 10px; border-bottom: 1px solid var(--border-alpha); transition: all 0.3s ease; }
        .record-item:last-child { border-bottom: none; }
        .record-item:hover { background: rgba(255, 255, 255, 0.05); }
        .record-item.is-pb { border-left: 4px solid var(--warning-color); }
        .record-mode-icon { font-size: 1.2rem; width: 24px; text-align: center; }
        .record-details-main { font-size: 0.9em; }
        .record-details-sub { font-size: 0.8em; opacity: 0.7; display: flex; gap: 10px; margin-top: 4px; }
        .record-stats { text-align: right; font-weight: bold; font-size: 1.1em; color: var(--warning-color); }
        .record-item:not(.is-pb) .record-stats { color: var(--text-primary); }
        
        .tier-badge { padding: 2px 6px; font-size: 0.7em; border-radius: 4px; color: #000; }
        .tier-Novice { background-color: #95a5a6; } .tier-Practitioner { background-color: #2ecc71; }
        .tier-Adept { background-color: #3498db; } .tier-Expert { background-color: #9b59b6; }
        .tier-Master { background: linear-gradient(45deg, #f1c40f, #f39c12); }
        .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 1000;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: rgba(10, 25, 47, 0.85); backdrop-filter: blur(15px);
            color: var(--text-primary); padding: 25px;
            border-radius: 20px; max-width: 600px; width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-alpha);
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { color: var(--primary-accent); margin-bottom: 15px; text-align: center; font-size: 1.5rem; }
        .modal-content p { margin-bottom: 10px; line-height: 1.6; color: var(--text-secondary); }
        .modal-content strong { color: var(--primary-accent); }
        .close-modal-btn { float: right; background: transparent; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: color 0.3s, transform 0.3s; }
        .close-modal-btn:hover { color: white; transform: rotate(90deg); }

        .report-section { border-top: 1px solid var(--border-alpha); margin-top: 20px; padding-top: 15px; }
        .report-section h4 { color: var(--text-primary); border-left: 4px solid var(--warning-color); padding-left: 10px; margin-bottom: 10px; }
        .report-metrics { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; background: var(--bg-darker-alpha); padding: 15px; border-radius: 10px; flex-wrap: wrap; gap: 10px;}
        .report-metric-item { flex-basis: 45%; }
        .report-metric-item span { display: block; }
        .report-metric-value { font-size: 1.8rem; font-weight: bold; color: var(--primary-accent); }
        .report-metric-label { font-size: 0.9rem; color: var(--text-secondary); }
        .report-tip { background: var(--bg-dark-alpha); padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; }
        #reportPerformanceAdvice h4 { font-size: 1.1em; color: var(--glow-color); border: none; padding-left: 0; margin-bottom: 8px;}
        #reportPerformanceAdvice p { font-size: 0.95em; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .game-container { padding: 15px; }
            .header p { font-size: 1rem; }
            .controls { flex-direction: column; gap: 20px; }
            .stats { flex-direction: column; gap: 15px; padding: 10px; }
            .stat-value { font-size: 22px; }
            .dashboard-main { grid-template-columns: 1fr; }
            .dashboard-header { flex-direction: column; gap: 10px; align-items: stretch; text-align: center; margin-bottom: 20px; }
            .record-details-sub { flex-wrap: wrap; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    <div class="game-container">
        <div class="header">
            <h1 class="title">ğŸ¯ é«˜çº§è®¤çŸ¥åŠŸèƒ½è®­ç»ƒ</h1>
            <p>ä¸“æ³¨åŠ›ã€è®°å¿†åŠ›ä¸æ€ç»´çµæ´»æ€§æŒ‘æˆ˜</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="gridSize">ç½‘æ ¼å¤§å°:</label>
                <select id="gridSize">
                    <option value="3">3Ã—3</option>
                    <option value="4">4Ã—4</option>
                    <option value="5" selected>5Ã—5</option>
                    <option value="6">6Ã—6</option>
                </select>
            </div>
            <div class="control-group">
                <label for="trainingMode">è®­ç»ƒæ¨¡å¼:</label>
                <select id="trainingMode">
                    <option value="standard">æ ‡å‡†æ¨¡å¼</option>
                    <option value="reverse">é€†åºæ¨¡å¼</option>
                    <option value="inhibit">æŠ‘åˆ¶æ§åˆ¶</option>
                    <option value="switch">ä»»åŠ¡åˆ‡æ¢</option>
                    <option value="memory">ç©ºé—´è®°å¿†</option>
                </select>
                <span class="info-icon" id="infoBtn">?</span>
            </div>
            <div class="button-group">
                <button class="btn" id="startBtn">å¼€å§‹è®­ç»ƒ</button>
                <button class="btn" id="resetBtn">é‡ç½®</button>
                <button class="btn" id="showReportBtn" style="display: none;">ç”ŸæˆæŠ¥å‘Š</button>
            </div>
        </div>

        <div class="game-area">
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="stats">
                <div class="stat-item"><div class="stat-value" id="currentNumber">1</div><div class="stat-label">ä¸‹ä¸€ä¸ªç›®æ ‡</div></div>
                <div class="stat-item"><div class="stat-value" id="timeElapsed">0</div><div class="stat-label">ç”¨æ—¶(ç§’)</div></div>
                <div class="stat-item"><div class="stat-value" id="errors">0</div><div class="stat-label">é”™è¯¯æ¬¡æ•°</div></div>
            </div>
            <div id="taskInstruction"></div>
            <div class="grid size-5" id="gameGrid"></div>
            <div class="message" id="message" style="display: none;"></div>
        </div>

        <div class="dashboard">
            <div class="dashboard-header">
                <h3>ğŸ§  ä¸ªäººè®¤çŸ¥ä»ªè¡¨ç›˜</h3>
                <button class="btn" id="clearRecordsBtn">æ¸…ç©ºè®°å½•</button>
            </div>
            <div class="dashboard-controls">
                <select id="filterMode"><option value="all">æ‰€æœ‰æ¨¡å¼</option></select>
            </div>
            <div class="dashboard-main">
                <div class="dashboard-profile">
                    <h4 class="dashboard-profile-title">äº”ç»´èƒ½åŠ›æ¨¡å‹</h4>
                    <div class="radar-chart-container">
                        <svg id="cognitiveProfileChart" class="radar-chart"></svg>
                    </div>
                </div>
                <div class="dashboard-summary">
                    <h4 class="dashboard-summary-title">æ ¸å¿ƒæ•°æ®æ‘˜è¦</h4>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="value" id="summaryTotalPlays">-</div><div class="label">æ€»è®­ç»ƒ</div></div>
                        <div class="summary-item"><div class="value" id="summaryPBs">-</div><div class="label">ä¸ªäººæœ€ä½³</div></div>
                        <div class="summary-item"><div class="value" id="summaryAvgCEI">-</div><div class="label">å¹³å‡CEI</div></div>
                        <div class="summary-item"><div class="value" id="summaryConsistency">-</div><div class="label">ä¸€è‡´æ€§</div></div>
                    </div>
                    <div class="summary-insight" id="summaryInsight">å¼€å§‹è®­ç»ƒï¼Œè§£é”æ‚¨çš„ä¸ªäººæ´å¯Ÿ...</div>
                </div>
            </div>
            <div id="trendChartContainer">
                 <svg id="trendChart" class="chart-svg"></svg>
            </div>
            <div id="recordsList"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="infoModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeInfoModalBtn">Ã—</button>
            <h3>è®­ç»ƒæ¨¡å¼è¯´æ˜</h3>
            <p><strong>æ ‡å‡†æ¨¡å¼:</strong> ç»å…¸ç©æ³•ã€‚æŒ‰ 1 åˆ° N çš„é¡ºåºä¾æ¬¡ç‚¹å‡»æ•°å­—ï¼Œè®­ç»ƒåŸºç¡€æ³¨æ„åŠ›å’Œè§†è§‰æœç´¢é€Ÿåº¦ã€‚</p>
            <p><strong>é€†åºæ¨¡å¼:</strong> ä»æœ€å¤§æ•°å€’åºç‚¹å‡»åˆ° 1ã€‚æŒ‘æˆ˜ä½ çš„å·¥ä½œè®°å¿†å’Œé€†å‘æ€ç»´èƒ½åŠ›ã€‚</p>
            <p><strong>æŠ‘åˆ¶æ§åˆ¶:</strong> æŒ‰é¡ºåºç‚¹å‡»æ•°å­—ï¼Œä½†å¿…é¡»<strong>è·³è¿‡æ‰€æœ‰æ©™è‰²å¡ç‰‡</strong>ã€‚è¿™ä¸ªæ¨¡å¼æ—¨åœ¨è®­ç»ƒä½ æŠ‘åˆ¶å†²åŠ¨ååº”çš„èƒ½åŠ›ã€‚</p>
            <p><strong>ä»»åŠ¡åˆ‡æ¢:</strong> <strong>è“è‰²èƒŒæ™¯æ‰¾æ•°å­—ï¼Œç»¿è‰²èƒŒæ™¯æ‰¾å­—æ¯</strong>ï¼ŒèƒŒæ™¯ä¼šéšæ—¶å˜åŒ–ã€‚è¿™æå¤§åœ°è€ƒéªŒä½ çš„è®¤çŸ¥çµæ´»æ€§ã€‚</p>
            <p><strong>ç©ºé—´è®°å¿†:</strong> å¡ç‰‡å‡ºç°å‡ ç§’åä¼šæ¶ˆå¤±ï¼Œä½ éœ€è¦å‡­å€Ÿè®°å¿†æŒ‰é¡ºåºç‚¹å‡»å®ƒä»¬åŸæ¥çš„ä½ç½®ã€‚è¿™æ˜¯å¯¹ä½ è§†è§‰ç©ºé—´è®°å¿†çš„ç»ˆæè€ƒéªŒã€‚</p>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeReportModalBtn">Ã—</button>
            <h3 id="reportTitle">ğŸ§  è®­ç»ƒåˆ†ææŠ¥å‘Š</h3>
            <p id="reportSummary" style="text-align: center; font-style: italic;"></p>
            <div class="report-metrics">
                <div class="report-metric-item">
                    <span class="report-metric-value" id="reportTime"></span>
                    <span class="report-metric-label">ç”¨æ—¶ (ç§’)</span>
                </div>
                <div class="report-metric-item">
                    <span class="report-metric-value" id="reportErrors"></span>
                    <span class="report-metric-label">é”™è¯¯æ¬¡æ•°</span>
                </div>
                 <div class="report-metric-item">
                    <span class="report-metric-value" id="reportPace"></span>
                    <span class="report-metric-label">å¹³å‡é€Ÿåº¦ (ç§’/ä¸ª)</span>
                </div>
                <div class="report-metric-item">
                    <span class="report-metric-value" id="reportCEI"></span>
                    <span class="report-metric-label">æœ¬è½®æ•ˆç‡ (CEI)</span>
                </div>
            </div>
            <div class="report-section">
                <h4>ğŸ¯ æ ¸å¿ƒèƒ½åŠ›è§£æ</h4>
                <p id="reportAbilityAnalysis"></p>
            </div>
             <div class="report-section">
                <h4>ğŸ’¡ è¡¨ç°è¯„ä¼°ä¸æå‡å»ºè®®</h4>
                <div id="reportPerformanceAdvice"></div>
            </div>
            <div class="report-section">
                <h4>ğŸ”¬ è„‘ç§‘å­¦å°è´´å£«</h4>
                <div class="report-tip" id="reportBrainTip"></div>
            </div>
        </div>
    </div>
    <audio id="correctSound" src="data:audio/mpeg;base64,..."></audio>
    <audio id="incorrectSound" src="data:audio/mpeg;base64,..."></audio>
    <audio id="winSound" src="data:audio/mpeg;base64,..."></audio>

<script>
class CognitiveTrainingApp {
    constructor() {
        // Game State
        this.startTime = null;
        this.errors = 0;
        this.isGameActive = false;
        this.timer = null;
        this.lastGameStats = null;
        this.currentTargets = [];
        this.currentTargetIndex = 0;
        this.noGoItems = new Set();
        this.taskSwitchState = { task: 'number', numbers: [], letters: [], numIndex: 0, letterIndex: 0 };
        
        this.initElements();
        this.bindEvents();
        
        // Initial setup
        this.gridSize = parseInt(this.gridSizeSelect.value);
        this.trainingMode = this.trainingModeSelect.value;
        this.maxNumber = this.gridSize * this.gridSize;
        this.gameGrid.className = `grid size-${this.gridSize}`;
        
        this.resetGame(true);
        this.initDashboard();
    }

    // --- ELEMENT INITIALIZATION & EVENT BINDING ---
    initElements() {
        const get = (id) => document.getElementById(id);
        // Game Elements
        this.gridSizeSelect = get('gridSize'); this.trainingModeSelect = get('trainingMode');
        this.startBtn = get('startBtn'); this.resetBtn = get('resetBtn'); this.showReportBtn = get('showReportBtn');
        this.gameGrid = get('gameGrid'); this.currentNumberDisplay = get('currentNumber');
        this.timeDisplay = get('timeElapsed'); this.errorsDisplay = get('errors');
        this.messageDiv = get('message'); this.progressFill = get('progressFill');
        this.taskInstruction = get('taskInstruction'); this.infoBtn = get('infoBtn');
        // Dashboard Elements
        this.filterModeSelect = get('filterMode'); this.clearRecordsBtn = get('clearRecordsBtn');
        this.summaryTotalPlays = get('summaryTotalPlays'); this.summaryPBs = get('summaryPBs');
        this.summaryAvgCEI = get('summaryAvgCEI'); this.summaryConsistency = get('summaryConsistency');
        this.summaryInsight = get('summaryInsight'); this.radarChartSVG = get('cognitiveProfileChart');
        this.trendChartSVG = get('trendChart'); this.recordsList = get('recordsList');
        // Sounds
        this.correctSound = get('correctSound'); this.incorrectSound = get('incorrectSound'); this.winSound = get('winSound');
        
        // Modal and report elements
        this.infoModal = get('infoModal');
        this.closeInfoModalBtn = get('closeInfoModalBtn');
        this.reportModal = get('reportModal');
        this.closeReportModalBtn = get('closeReportModalBtn');
        this.reportTitle = get('reportTitle');
        this.reportSummary = get('reportSummary');
        this.reportTime = get('reportTime');
        this.reportErrors = get('reportErrors');
        this.reportPace = get('reportPace');
        this.reportCEI = get('reportCEI'); // ADDED
        this.reportAbilityAnalysis = get('reportAbilityAnalysis');
        this.reportPerformanceAdvice = get('reportPerformanceAdvice');
        this.reportBrainTip = get('reportBrainTip');
    }
    
    bindEvents() {
        // Game Controls
        this.startBtn.addEventListener('click', () => this.startGame());
        this.resetBtn.addEventListener('click', () => this.resetGame(true));
        this.gridSizeSelect.addEventListener('change', () => this.updateGridSize());
        this.trainingModeSelect.addEventListener('change', () => this.updateTrainingMode());
        // Dashboard Controls
        this.filterModeSelect.addEventListener('change', () => this.updateDashboard());
        this.clearRecordsBtn.addEventListener('click', () => this.clearRecords());
        // Modal and report event bindings
        this.showReportBtn.addEventListener('click', () => this.showReport());
        this.infoBtn.addEventListener('click', () => this.infoModal.classList.add('visible'));
        
        const setupModalClose = (modal, closeBtn) => {
            if (modal && closeBtn) {
                closeBtn.addEventListener('click', () => modal.classList.remove('visible'));
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('visible'); });
            }
        };
        setupModalClose(this.infoModal, this.closeInfoModalBtn);
        setupModalClose(this.reportModal, this.closeReportModalBtn);
    }

    // --- CORE GAME LOGIC (UNCHANGED) ---
    updateGridSize() { this.gridSize = parseInt(this.gridSizeSelect.value); this.maxNumber = this.gridSize * this.gridSize; this.gameGrid.className = `grid size-${this.gridSize}`; this.resetGame(true); }
    updateTrainingMode() { this.trainingMode = this.trainingModeSelect.value; this.resetGame(true); }
    resetGame(fullReset = false) { this.isGameActive = false; this.errors = 0; this.currentTargetIndex = 0; clearInterval(this.timer); this.startBtn.disabled = false; this.gridSizeSelect.disabled = false; this.trainingModeSelect.disabled = false; this.showReportBtn.style.display = 'none'; if (fullReset) this.createGrid(); this.updateDisplay(); this.hideMessage(); this.progressFill.style.width = '0%'; if(this.timeDisplay) {this.timeDisplay.textContent = '0'}; }
    createGrid() { this.gameGrid.innerHTML = ''; const items = this.generateItemsForMode(); this.shuffleArray(items); items.forEach(item => { const card = document.createElement('div'); card.className = 'card'; card.dataset.value = item; const content = document.createElement('span'); content.className = 'cell-content'; content.textContent = item; card.appendChild(content); if (this.trainingMode === 'inhibit' && this.noGoItems.has(item)) card.classList.add('no-go'); card.addEventListener('click', () => this.handleCellClick(card)); this.gameGrid.appendChild(card); }); }
    generateItemsForMode() { let items = Array.from({ length: this.maxNumber }, (_, i) => i + 1); this.currentTargets = []; this.noGoItems.clear(); switch(this.trainingMode) { case 'standard': this.currentTargets = [...items]; break; case 'reverse': this.currentTargets = items.slice().reverse(); break; case 'inhibit': let allItems = [...items]; const noGoCount = Math.floor(this.maxNumber * 0.2); this.shuffleArray(allItems); for(let i = 0; i < noGoCount; i++) this.noGoItems.add(allItems[i]); this.currentTargets = items.filter(item => !this.noGoItems.has(item)).sort((a, b) => a - b); break; case 'switch': const numCount = Math.ceil(this.maxNumber / 2); items = []; this.taskSwitchState.numbers = Array.from({ length: numCount }, (_, i) => i + 1); this.taskSwitchState.letters = Array.from({ length: this.maxNumber - numCount }, (_, i) => String.fromCharCode(65 + i)); items.push(...this.taskSwitchState.numbers, ...this.taskSwitchState.letters); this.currentTargets = items; break; case 'memory': this.currentTargets = [...items]; break; } return (this.trainingMode === 'switch') ? this.shuffleArray([...this.taskSwitchState.numbers, ...this.taskSwitchState.letters]) : items; }
    startGame() { this.resetGame(false); this.createGrid(); this.isGameActive = true; this.startTime = Date.now(); this.currentTargetIndex = 0; if (this.trainingMode === 'switch') { this.taskSwitchState.task = 'number'; this.taskSwitchState.numIndex = 0; this.taskSwitchState.letterIndex = 0; } if (this.trainingMode === 'memory') { const displayTime = Math.max(1500, this.maxNumber * 100); this.showMessage(`è®°å¿†æ—¶é—´...`, 'info'); setTimeout(() => { this.gameGrid.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); this.hideMessage(); }, displayTime); } this.startBtn.disabled = true; this.gridSizeSelect.disabled = true; this.trainingModeSelect.disabled = true; this.updateDisplay(); this.startTimer(); }
    
    handleCellClick(card) {
        if (!this.isGameActive || card.classList.contains('matched')) return;
        const clickedValueStr = card.dataset.value;
        const clickedValue = isNaN(parseInt(clickedValueStr)) ? clickedValueStr : parseInt(clickedValueStr);
        let isCorrect = false;

        if (this.trainingMode === 'inhibit') {
            if (card.classList.contains('no-go')) {
                this.triggerError(card);
                return;
            }
            isCorrect = (clickedValue === this.currentTargets[this.currentTargetIndex]);
        } else if (this.trainingMode === 'switch') {
            const { task, numbers, letters, numIndex, letterIndex } = this.taskSwitchState;
            if (task === 'number' && typeof clickedValue === 'number' && clickedValue === numbers[numIndex]) {
                isCorrect = true;
                this.taskSwitchState.numIndex++;
                if (this.taskSwitchState.numIndex >= numbers.length) {
                    this.switchTask();
                } else if (numIndex > 0 && numIndex % (3 + Math.floor(Math.random() * 3)) === 0) {
                    this.switchTask();
                }
            } else if (task === 'letter' && typeof clickedValue === 'string' && clickedValue === letters[letterIndex]) {
                isCorrect = true;
                this.taskSwitchState.letterIndex++;
                if (this.taskSwitchState.letterIndex >= letters.length) {
                    this.switchTask();
                } else if (letterIndex > 0 && letterIndex % (3 + Math.floor(Math.random() * 3)) === 0) {
                    this.switchTask();
                }
            }
            if (isCorrect) this.currentTargetIndex++;
        } else {
            isCorrect = (clickedValue === this.currentTargets[this.currentTargetIndex]);
        }

        if (isCorrect) {
            this.playSound(this.correctSound);
            card.classList.add('matched');
            if (this.trainingMode === 'memory') card.classList.remove('hidden');
            if (this.trainingMode !== 'switch') this.currentTargetIndex++;
            const totalTargets = (this.trainingMode === 'switch') ? (this.taskSwitchState.numbers.length + this.taskSwitchState.letters.length) : this.currentTargets.length;
            this.progressFill.style.width = (this.currentTargetIndex / totalTargets) * 100 + '%';
            if (this.currentTargetIndex >= totalTargets) {
                this.endGame(true);
            } else {
                this.updateDisplay();
            }
        } else {
            this.triggerError(card);
        }
    }

    switchTask() { const { task, numIndex, numbers, letterIndex, letters } = this.taskSwitchState; if (task === 'number' && letterIndex < letters.length) this.taskSwitchState.task = 'letter'; else if (task === 'letter' && numIndex < numbers.length) this.taskSwitchState.task = 'number'; this.updateDisplay(); }
    triggerError(card) { this.playSound(this.incorrectSound); card.classList.add('error'); this.errors++; if(this.errorsDisplay){this.errorsDisplay.textContent = this.errors;} setTimeout(() => card.classList.remove('error'), 600); }
    endGame(completed) { 
        this.isGameActive = false; 
        clearInterval(this.timer); 
        this.startBtn.disabled = false; 
        this.gridSizeSelect.disabled = false; 
        this.trainingModeSelect.disabled = false; 
        if (completed) { 
            this.playSound(this.winSound); 
            const totalTime = Math.max(1, Math.floor((Date.now() - this.startTime) / 1000)); 
            this.showMessage(`ğŸ‰ æ­å–œå®Œæˆï¼ç”¨æ—¶ï¼š${totalTime}ç§’ï¼Œé”™è¯¯ï¼š${this.errors}æ¬¡`, 'success'); 
            const totalItems = (this.trainingMode === 'switch') ? (this.taskSwitchState.numbers.length + this.taskSwitchState.letters.length) : this.currentTargets.length; 
            this.lastGameStats = { time: totalTime, errors: this.errors, gridSize: this.gridSize, mode: this.trainingMode, totalItems: totalItems }; 
            this.saveRecord(this.lastGameStats); 
            this.showReportBtn.style.display = 'inline-block'; 
            this.generateAndShowReport();
        } 
    }
    
    // --- #region MODIFIED REPORT LOGIC ---
    getReportContent(stats) {
        const { time, errors, mode, totalItems, gridSize } = stats;
        const pace = (time / totalItems).toFixed(2);
        const cei = this.calculateCEI(stats);

        const content = {
            title: "", summary: "", abilityAnalysis: "", performanceAdvice: "", brainTip: "", cei: cei
        };
        
        const modeNames = { 'standard': 'æ ‡å‡†æ¨¡å¼', 'reverse': 'é€†åºæ¨¡å¼', 'inhibit': 'æŠ‘åˆ¶æ§åˆ¶', 'switch': 'ä»»åŠ¡åˆ‡æ¢', 'memory': 'ç©ºé—´è®°å¿†' };
        content.title = `"${modeNames[mode]}" (${gridSize}Ã—${gridSize}) è®­ç»ƒæŠ¥å‘Š`;

        switch(mode) {
            case 'standard':
                content.abilityAnalysis = "æ­¤æ¨¡å¼ä¸“æ³¨äºé”»ç‚¼æ‚¨çš„<strong>è§†è§‰æœç´¢</strong>ä¸<strong>é€‰æ‹©æ€§æ³¨æ„</strong>èƒ½åŠ›ã€‚è¿™å°±åƒåœ¨å¤æ‚çš„ç¯å¢ƒä¸­å¿«é€Ÿå®šä½å…³é”®ä¿¡æ¯ï¼Œæ˜¯è®¸å¤šé«˜çº§è®¤çŸ¥æ´»åŠ¨çš„åŸºç¡€ã€‚";
                content.brainTip = "å¤§è„‘çš„<strong>é¡¶å¶çš®å±‚</strong>åœ¨å¤„ç†ç©ºé—´å…³ç³»å’Œå¼•å¯¼æ³¨æ„åŠ›æ–¹é¢è‡³å…³é‡è¦ã€‚æŒç»­è®­ç»ƒå¯ä»¥ä¼˜åŒ–å…¶ç¥ç»å›è·¯ï¼Œæå‡ä¿¡æ¯å¤„ç†æ•ˆç‡ã€‚";
                break;
            case 'reverse':
                content.abilityAnalysis = "é€†åºç‚¹å‡»æŒ‘æˆ˜äº†æ‚¨çš„<strong>å·¥ä½œè®°å¿†</strong>ã€‚æ‚¨éœ€è¦åœ¨è„‘ä¸­ç»´æŒå¹¶æ›´æ–°ä¸€ä¸ªå€’åºçš„æ•°å­—åºåˆ—ï¼Œè¿™æå¤§åœ°é”»ç‚¼äº†å¤§è„‘åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä¸´æ—¶å­˜å‚¨å’Œå¤„ç†ä¿¡æ¯çš„èƒ½åŠ›ã€‚";
                content.brainTip = "<strong>å‰é¢å¶çš®å±‚</strong>æ˜¯å¤§è„‘çš„â€œæ‰§è¡Œä¸­æ¢â€ï¼Œå®ƒè´Ÿè´£è§„åˆ’ã€å†³ç­–å’Œç»´æŒå·¥ä½œè®°å¿†ã€‚è¿™ç±»è®­ç»ƒèƒ½æœ‰æ•ˆå¢å¼ºå…¶åŠŸèƒ½ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°å¤„ç†å¤æ‚ä»»åŠ¡ã€‚";
                break;
            case 'inhibit':
                 content.abilityAnalysis = "â€œGo/No-Goâ€ä»»åŠ¡æ˜¯è®­ç»ƒ<strong>æŠ‘åˆ¶æ§åˆ¶</strong>çš„ç»å…¸æ–¹æ³•ã€‚å®ƒè¦æ±‚æ‚¨æŠ‘åˆ¶ä½ç‚¹å‡»ç‰¹å®šç›®æ ‡ï¼ˆæ©™è‰²æ–¹å—ï¼‰çš„å†²åŠ¨æ€§ååº”ï¼Œè¿™å¯¹äºåŸ¹å…»ä¸“æ³¨åŠ›å’Œå‡å°‘å†²åŠ¨å†³ç­–è‡³å…³é‡è¦ã€‚";
                 content.brainTip = "æŠ‘åˆ¶ä¸å½“è¡Œä¸ºçš„èƒ½åŠ›æ˜¯å¿ƒæ™ºæˆç†Ÿçš„å…³é”®æ ‡å¿—ã€‚å¤§è„‘ä¸­çš„<strong>å‰æ‰£å¸¦çš®å±‚</strong>å’Œå‰é¢å¶ååŒå·¥ä½œï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°â€œä¸‰æ€è€Œåè¡Œâ€ã€‚";
                 break;
            case 'switch':
                content.abilityAnalysis = "ä»»åŠ¡åˆ‡æ¢è®­ç»ƒç›´æ¥è€ƒéªŒæ‚¨çš„<strong>è®¤çŸ¥çµæ´»æ€§</strong>â€”â€”å³åœ¨ä¸åŒè§„åˆ™æˆ–æ€ç»´å®šåŠ¿ä¹‹é—´æµç•…è½¬æ¢çš„èƒ½åŠ›ã€‚è¿™æ¨¡æ‹Ÿäº†ç°ä»£å·¥ä½œä¸­é¢‘ç¹åˆ‡æ¢ä»»åŠ¡çš„åœºæ™¯ï¼Œè®­ç»ƒæœ‰åŠ©äºé™ä½â€œåˆ‡æ¢æˆæœ¬â€ã€‚";
                content.brainTip = "è®¤çŸ¥çµæ´»æ€§å¼ºçš„äººèƒ½æ›´å¿«åœ°é€‚åº”å˜åŒ–ã€ä»ä¸åŒè§’åº¦çœ‹é—®é¢˜ã€‚è¿™ç§èƒ½åŠ›ä¾èµ–äºå¤§è„‘ä¸­å¤šä¸ªè„‘åŒºï¼ˆå¦‚å‰é¢å¶ã€é¡¶å¶ï¼‰ä¹‹é—´çµæ´»é«˜æ•ˆçš„ååŒå·¥ä½œã€‚";
                break;
            case 'memory':
                content.abilityAnalysis = "æ­¤æ¨¡å¼ç›´æ¥é”»ç‚¼äº†æ‚¨çš„<strong>è§†è§‰ç©ºé—´å·¥ä½œè®°å¿†</strong>ã€‚æ‚¨éœ€è¦åœ¨è„‘æµ·ä¸­æ„å»ºå¹¶ä¿æŒä¸€å¹…â€œæ•°å­—åœ°å›¾â€ï¼Œå¹¶æ ¹æ®è¿™å¹…å¿ƒç†åœ°å›¾è¿›è¡Œæ“ä½œï¼Œè¿™å¯¹æ–¹å‘æ„Ÿã€è§„åˆ’èƒ½åŠ›å’Œè®°å¿†åŠ›éƒ½æ˜¯æå¥½çš„è®­ç»ƒã€‚";
                content.brainTip = "å¤§è„‘ä¸­çš„<strong>æµ·é©¬ä½“</strong>åœ¨å½¢æˆæ–°è®°å¿†å’Œç©ºé—´å¯¼èˆªä¸­æ‰®æ¼”ç€æ ¸å¿ƒè§’è‰²ã€‚ç©ºé—´è®°å¿†è®­ç»ƒä¸ä»…èƒ½å¢å¼ºçŸ­æœŸè®°å¿†ï¼Œé•¿æœŸåšæŒè¿˜æœ‰åŠ©äºä¿ƒè¿›ç¥ç»å¯å¡‘æ€§ã€‚";
                break;
        }

        const paceThreshold = 1.5 + (gridSize - 3) * 0.35;
        const errorThreshold = Math.max(1, Math.floor(totalItems * 0.08));
        const isFast = parseFloat(pace) < paceThreshold;
        const isAccurate = errors <= errorThreshold;

        let profileTitle = "";
        let profileAdvice = "";

        if (isFast && isAccurate) {
            profileTitle = "ğŸ† é«˜æ•ˆæ‰§è¡Œè€… (Efficient Executor)";
            profileAdvice = `è¡¨ç°å‡ºè‰²ï¼æ‚¨ä»¥ <strong>${pace}ç§’/ä¸ª</strong> çš„é«˜é€Ÿå’Œä»… <strong>${errors}æ¬¡</strong> å¤±è¯¯å®Œæˆäº†æŒ‘æˆ˜ï¼Œå±•ç°äº†å“è¶Šçš„ä¸“æ³¨åŠ›å’Œæ‰§è¡Œæ•ˆç‡ã€‚æ‚¨çš„è¡¨ç°è¡¨æ˜å¤§è„‘èƒ½å¤Ÿå¿«é€Ÿã€å‡†ç¡®åœ°å¤„ç†ä¿¡æ¯ã€‚<br><br><strong>æå‡å»ºè®®ï¼š</strong> ä¿æŒçŠ¶æ€ï¼Œå°è¯•æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„ç½‘æ ¼ï¼ˆå¦‚ 6x6ï¼‰æˆ–æ›´å¤æ‚çš„æ¨¡å¼ï¼Œä¸ºå¤§è„‘æä¾›æ–°çš„åˆºæ¿€ï¼ŒæŒç»­æ‹“å±•è®¤çŸ¥è¾¹ç•Œã€‚`;
            content.summary = `ä»¥å‡ºè‰²çš„é€Ÿåº¦å’Œç²¾åº¦å®Œæˆäº†æœ¬æ¬¡è®­ç»ƒï¼Œå±•ç°äº†å¼ºå¤§çš„è®¤çŸ¥æ§åˆ¶åŠ›ã€‚`;
        } else if (!isFast && isAccurate) {
            profileTitle = "ğŸ§ è°¨æ…ç­–ç•¥å®¶ (Prudent Strategist)";
            profileAdvice = `å‡†ç¡®æ€§æä½³ï¼æ‚¨å¯¹ä»»åŠ¡çš„ä¸“æ³¨å’Œç»†è‡´ä»¤äººå°è±¡æ·±åˆ»ï¼Œå¤±è¯¯æ¬¡æ•°æ§åˆ¶åœ¨ <strong>${errors}æ¬¡</strong>ã€‚è¿™åæ˜ äº†å¼ºå¤§çš„è‡ªæˆ‘ç›‘æ§èƒ½åŠ›å’Œå¯¹ç²¾ç¡®åº¦çš„é‡è§†ã€‚<br><br><strong>æå‡å»ºè®®ï¼š</strong> åœ¨ä¿æŒé«˜å‡†ç¡®ç‡çš„å‰æä¸‹ï¼Œå¯ä»¥å°è¯•é€æ­¥æå‡èŠ‚å¥æ„Ÿã€‚è¯•ç€ç›¸ä¿¡æ‚¨çš„ç¬¬ä¸€ååº”ï¼Œå‡å°‘å†³ç­–å‰çš„çŠ¹è±«ï¼Œå°†â€œæ€è€ƒ-è¡ŒåŠ¨â€çš„è¿‡ç¨‹å˜å¾—æ›´åŠ æµç•…ã€‚`;
            content.summary = `ä»¥è¿‘ä¹å®Œç¾çš„å‡†ç¡®ç‡å®Œæˆäº†ä»»åŠ¡ï¼Œå±•ç¤ºäº†ä¸¥è°¨å’Œä¸“æ³¨çš„ä¼˜ç§€å“è´¨ã€‚`;
        } else if (isFast && !isAccurate) {
            profileTitle = "âš¡ï¸ æé€Ÿæ¢ç´¢è€… (Rapid Explorer)";
            profileAdvice = `é€Ÿåº¦æƒŠäººï¼æ‚¨çš„ååº”é€Ÿåº¦ï¼ˆ<strong>${pace}ç§’/ä¸ª</strong>ï¼‰éå¸¸å¿«ï¼Œä½† <strong>${errors}æ¬¡</strong> çš„å¤±è¯¯è¡¨æ˜ï¼Œä¸ºäº†è¿½æ±‚é€Ÿåº¦å¯èƒ½ç‰ºç‰²äº†ä¸€éƒ¨åˆ†å‡†ç¡®æ€§ã€‚è¿™åœ¨è®¤çŸ¥å¿ƒç†å­¦ä¸­è¢«ç§°ä¸ºâ€œé€Ÿåº¦-å‡†ç¡®æ€§æƒè¡¡â€ã€‚<br><br><strong>æå‡å»ºè®®ï¼š</strong> å°è¯•åœ¨ç‚¹å‡»å‰åŠ å…¥ä¸€ä¸ªå¾®ç§’çº§çš„â€œç¡®è®¤â€ç¯èŠ‚ã€‚æ”¾æ…¢ä¸€ç‚¹ç‚¹ï¼Œè®©è§†è§‰ç¡®è®¤è·Ÿä¸Šæ‰‹çš„é€Ÿåº¦ï¼Œåè€Œå¯èƒ½å› ä¸ºå‡å°‘äº†é”™è¯¯ä¿®æ­£çš„æ—¶é—´è€Œè·å¾—æ›´å¥½çš„æ€»æˆç»©ã€‚`;
            content.summary = `ä»¥é—ªç”µèˆ¬çš„é€Ÿåº¦å®Œæˆäº†æŒ‘æˆ˜ï¼Œä½†åœ¨å‡†ç¡®æ€§æ–¹é¢è¿˜æœ‰æå‡ç©ºé—´ã€‚`;
        } else { // !isFast && !isAccurate
            profileTitle = "ğŸŒ± æ½œåŠ›æ–°æ˜Ÿ (Rising Star)";
            profileAdvice = `æ¯ä¸€æ¬¡è®­ç»ƒéƒ½æ˜¯ä¸€æ¬¡å®è´µçš„è¿›æ­¥ï¼è¿™æ¬¡æŒ‘æˆ˜å¯èƒ½æ„Ÿè§‰æœ‰äº›å›°éš¾ï¼Œä½†è¿™æ­£æ˜¯å¤§è„‘åœ¨å­¦ä¹ å’Œå»ºç«‹æ–°ç¥ç»è¿æ¥çš„æ ‡å¿—ã€‚<br><br><strong>æå‡å»ºè®®ï¼š</strong> ä¸å¿…ç°å¿ƒï¼å»ºè®®å…ˆä»è¾ƒå°çš„ç½‘æ ¼ï¼ˆå¦‚ 3x3 æˆ– 4x4ï¼‰å¼€å§‹ï¼Œå°†ç›®æ ‡è®¾å®šä¸ºâ€œé›¶å¤±è¯¯â€å®Œæˆä¸€æ¬¡ï¼Œæš‚æ—¶å¿½ç•¥æ—¶é—´ã€‚å½“æ‚¨èƒ½ç¨³å®šã€å‡†ç¡®åœ°å®Œæˆåï¼Œé€Ÿåº¦è‡ªç„¶ä¼šéšä¹‹æå‡ã€‚`;
            content.summary = `å®Œæˆäº†ä¸€æ¬¡å……æ»¡æŒ‘æˆ˜çš„è®­ç»ƒï¼Œè¿™æ˜¯å¤§è„‘æˆé•¿çš„å¿…ç»ä¹‹è·¯ã€‚`;
        }
        
        content.performanceAdvice = `<h4>${profileTitle}</h4><p>${profileAdvice}</p>`;
        return content;
    }

    generateAndShowReport() {
        if (!this.lastGameStats) return;
        const stats = this.lastGameStats;
        const reportContent = this.getReportContent(stats);

        this.reportTitle.textContent = reportContent.title;
        this.reportSummary.innerHTML = reportContent.summary;
        this.reportTime.textContent = stats.time;
        this.reportErrors.textContent = stats.errors;
        this.reportPace.textContent = (stats.time / stats.totalItems).toFixed(2);
        this.reportCEI.textContent = reportContent.cei;
        this.reportAbilityAnalysis.innerHTML = reportContent.abilityAnalysis;
        this.reportPerformanceAdvice.innerHTML = reportContent.performanceAdvice;
        this.reportBrainTip.innerHTML = `<strong>å°çŸ¥è¯†ï¼š</strong> ${reportContent.brainTip}`;

        this.showReport();
    }
    
    showReport() {
        if (this.lastGameStats) {
            this.reportModal.classList.add('visible');
        } else {
            alert('è¯·å…ˆå®Œæˆä¸€å±€æ¸¸æˆä»¥ç”ŸæˆæŠ¥å‘Šã€‚');
        }
    }
    // --- #endregion ---

    // --- DISPLAY & UI HELPERS (UNCHANGED) ---
    updateDisplay() { let nextTarget = ''; if (this.isGameActive) { if (this.trainingMode === 'switch') { const { task, numbers, letters, numIndex, letterIndex } = this.taskSwitchState; nextTarget = (task === 'number') ? (numbers[numIndex] || '...') : (letters[letterIndex] || '...'); this.taskInstruction.textContent = `è¯·æŒ‰é¡ºåºç‚¹å‡»ã€${task === 'number' ? 'æ•°å­—' : 'å­—æ¯'}ã€‘`; const isNumberTask = task === 'number'; this.gameGrid.style.background = isNumberTask ? 'rgba(52, 152, 219, 0.2)' : 'rgba(46, 204, 113, 0.2)'; this.taskInstruction.style.background = isNumberTask ? 'linear-gradient(135deg, #3498db, #2980b9)' : 'linear-gradient(135deg, #2ecc71, #27ae60)'; } else { nextTarget = this.currentTargets[this.currentTargetIndex] || 'ğŸ‰'; } } else { nextTarget = (this.trainingMode === 'reverse') ? this.maxNumber : '1'; } if(this.currentNumberDisplay){this.currentNumberDisplay.textContent = nextTarget;} if(this.errorsDisplay){this.errorsDisplay.textContent = this.errors;} if (!this.isGameActive) { this.taskInstruction.textContent = ''; this.taskInstruction.style.background = 'transparent'; } }
    
    // --- DASHBOARD LOGIC (UNCHANGED) ---
    initDashboard() { const modes = { 'standard': 'æ ‡å‡†', 'reverse': 'é€†åº', 'inhibit': 'æŠ‘åˆ¶', 'switch': 'åˆ‡æ¢', 'memory': 'è®°å¿†' }; Object.keys(modes).forEach(key => this.filterModeSelect.innerHTML += `<option value="${key}">${modes[key]}</option>`); this.updateDashboard(); }
    updateDashboard() { const allRecords = this.getRecords(); const filter = this.filterModeSelect.value; const filteredRecords = (filter === 'all') ? allRecords : allRecords.filter(r => r.mode === filter); this.updateSummary(allRecords, filteredRecords); this.displayRadarChart(allRecords); this.displayTrendChart(filteredRecords); this.displayRecordsList(filteredRecords); }
    updateSummary(allRecords, filteredRecords) { if (allRecords.length === 0) { this.summaryTotalPlays.textContent = '0'; this.summaryPBs.textContent = '0'; this.summaryAvgCEI.textContent = '-'; this.summaryConsistency.textContent = '-'; this.summaryInsight.textContent = 'å¼€å§‹è®­ç»ƒï¼Œè§£é”æ‚¨çš„ä¸ªäººæ´å¯Ÿ...'; return; } this.summaryTotalPlays.textContent = allRecords.length; this.summaryPBs.textContent = Object.keys(this.getPersonalBests(allRecords)).length; const filteredCEIs = filteredRecords.map(r => this.calculateCEI(r)); const avgCEI = filteredCEIs.length > 0 ? Math.round(filteredCEIs.reduce((a, b) => a + b, 0) / filteredCEIs.length) : 0; this.summaryAvgCEI.textContent = avgCEI || '-'; if (filteredCEIs.length > 1) { const mean = avgCEI; const stdDev = Math.sqrt(filteredCEIs.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / filteredCEIs.length); const consistency = Math.max(0, Math.round(100 - (stdDev / mean) * 100)); this.summaryConsistency.textContent = `${consistency}%`; } else { this.summaryConsistency.textContent = '-'; } this.summaryInsight.textContent = this.generateInsight(allRecords); }
    generateInsight(allRecords) { if (allRecords.length < 3) return "ç»§ç»­è®­ç»ƒä»¥è·å¾—æ›´æ·±å…¥çš„åˆ†æã€‚"; const skillScores = this.getCognitiveProfileScores(allRecords); const weakestSkill = Object.keys(skillScores).reduce((a, b) => skillScores[a] < skillScores[b] ? a : b); const skillNames = { processingSpeed: 'å¤„ç†é€Ÿåº¦', workingMemory: 'å·¥ä½œè®°å¿†', inhibitoryControl: 'æŠ‘åˆ¶æ§åˆ¶', cognitiveFlexibility: 'è®¤çŸ¥çµæ´»æ€§', visualSpatial: 'ç©ºé—´è®°å¿†' }; return `å½“å‰éœ€é‡ç‚¹å…³æ³¨ â€œ${skillNames[weakestSkill]}â€ èƒ½åŠ›çš„æå‡ã€‚`; }
    displayRadarChart(allRecords) { this.radarChartSVG.innerHTML = ''; if (allRecords.length === 0) { this.radarChartSVG.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--text-secondary)" font-size="12">æš‚æ— æ•°æ®</text>`; return; } const scores = this.getCognitiveProfileScores(allRecords); const labels = ['é€Ÿåº¦', 'å·¥ä½œè®°å¿†', 'æŠ‘åˆ¶', 'çµæ´»æ€§', 'ç©ºé—´è®°å¿†']; const dataPoints = [scores.processingSpeed, scores.workingMemory, scores.inhibitoryControl, scores.cognitiveFlexibility, scores.visualSpatial]; const size = this.radarChartSVG.getBoundingClientRect().width; const center = size / 2; const radius = center * 0.75; const angleSlice = (Math.PI * 2) / labels.length; for (let i = 1; i <= 4; i++) { let path = 'M '; for (let j = 0; j < labels.length; j++) { const r = radius * (i / 4); const x = center + r * Math.cos(angleSlice * j - Math.PI / 2); const y = center + r * Math.sin(angleSlice * j - Math.PI / 2); path += `${x},${y} L `; } this.radarChartSVG.innerHTML += `<path d="${path.slice(0, -2)}Z" class="radar-grid" />`; } labels.forEach((label, i) => { const x2 = center + radius * Math.cos(angleSlice * i - Math.PI / 2); const y2 = center + radius * Math.sin(angleSlice * i - Math.PI / 2); this.radarChartSVG.innerHTML += `<line x1="${center}" y1="${center}" x2="${x2}" y2="${y2}" class="radar-axis" />`; const labelX = center + (radius * 1.2) * Math.cos(angleSlice * i - Math.PI / 2); const labelY = center + (radius * 1.25) * Math.sin(angleSlice * i - Math.PI / 2); this.radarChartSVG.innerHTML += `<text x="${labelX}" y="${labelY}" class="radar-labels">${label}</text>`; }); let dataPath = 'M '; dataPoints.forEach((point, i) => { const r = radius * (point / 100); const x = center + r * Math.cos(angleSlice * i - Math.PI / 2); const y = center + r * Math.sin(angleSlice * i - Math.PI / 2); dataPath += `${x},${y} L `; }); this.radarChartSVG.innerHTML += `<path d="${dataPath.slice(0, -2)}Z" class="radar-area" />`; }
    displayTrendChart(records) { this.trendChartSVG.innerHTML = ''; if (records.length < 2) { this.trendChartSVG.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--text-secondary)">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ•°æ®ä¸è¶³</text>`; return; } const data = records.map(r => ({ value: this.calculateCEI(r) })).slice(-15); const width = this.trendChartSVG.clientWidth; const height = this.trendChartSVG.clientHeight; const padding = { top: 15, right: 10, bottom: 5, left: 10 }; const maxValue = Math.max(...data.map(d => d.value)); const minValue = Math.min(...data.map(d => d.value)); const valueRange = maxValue - minValue === 0 ? 1 : maxValue - minValue; const xStep = (width - padding.left - padding.right) / (data.length - 1); const getCoords = (d, i) => ({ x: padding.left + i * xStep, y: padding.top + (height - padding.top - padding.bottom) * (1 - (d.value - minValue) / valueRange) }); let linePath = "M"; data.forEach((d, i) => { const {x, y} = getCoords(d, i); if (i === 0) { linePath += `${x},${y}`; } else { const {x: prevX, y: prevY} = getCoords(data[i-1], i-1); const cp1x = prevX + xStep * 0.5; const cp2x = x - xStep * 0.5; linePath += ` C ${cp1x},${prevY} ${cp2x},${y} ${x},${y}`; } }); this.trendChartSVG.innerHTML = `<path class="chart-line" d="${linePath}" />`; }
    displayRecordsList(records) { this.recordsList.innerHTML = ''; if (records.length === 0) { this.recordsList.innerHTML = `<div class="empty-state">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚</div>`; return; } const pbs = this.getPersonalBests(this.getRecords()); const modeIcons = {'standard': 'ğŸ¯', 'reverse': 'âª', 'inhibit': 'âœ‹', 'switch': 'ğŸ”„', 'memory': 'ğŸ§ '}; records.sort((a,b) => new Date(b.date.replace(/-/g, '/')).getTime() - new Date(a.date.replace(/-/g, '/')).getTime()); this.recordsList.innerHTML = records.slice(0, 10).map(r => { const key = `${r.mode}-${r.gridSize}`; const isPb = pbs[key] && pbs[key].date === r.date; const cei = this.calculateCEI(r); const tier = this.getTier(cei); return `<div class="record-item ${isPb ? 'is-pb' : ''}"><span class="record-mode-icon">${modeIcons[r.mode]||'ğŸ”¹'}</span><div><div class="record-details-main">${r.gridSize}Ã—${r.gridSize} (${this.getModeName(r.mode)})</div><div class="record-details-sub"><span>${r.date}</span><span class="tier-badge tier-${tier.name}">${tier.name}</span></div></div><div class="record-stats">${cei} CEI ${isPb?'ğŸ†':''}</div></div>`; }).join(''); }
    
    // --- UTILITY & DATA METHODS (UNCHANGED) ---
    calculateCEI(stats) { const { time, errors, gridSize, totalItems, mode } = stats; if (time <= 0) return 0; const modeMultipliers = { standard: 1.0, reverse: 1.1, inhibit: 1.25, memory: 1.6, switch: 1.5 }; const multiplier = modeMultipliers[mode] || 1.0; const errorPenalty = (errors * (gridSize * 2.5)); const baseScore = ((totalItems * 2.5) / time) * 100; return Math.max(0, Math.round((baseScore - errorPenalty) * multiplier)); }
    getTier(cei) { if (cei > 1200) return { name: 'Master' }; if (cei > 900) return { name: 'Expert' }; if (cei > 600) return { name: 'Adept' }; if (cei > 300) return { name: 'Practitioner' }; return { name: 'Novice' }; }
    getPersonalBests(records) { return records.reduce((acc, r) => { const key = `${r.mode}-${r.gridSize}`; const currentCEI = this.calculateCEI(r); if (!acc[key] || currentCEI > this.calculateCEI(acc[key])) { acc[key] = r; } return acc; }, {}); }
    getCognitiveProfileScores(allRecords) { const maxCEIbyMode = allRecords.reduce((acc, r) => { const cei = this.calculateCEI(r); if (!acc[r.mode] || cei > acc[r.mode]) { acc[r.mode] = cei; } return acc; }, {}); const getBestCEIForModes = (modes) => modes.reduce((max, mode) => Math.max(max, maxCEIbyMode[mode] || 0), 0); const scores = { processingSpeed: getBestCEIForModes(['standard']), workingMemory: getBestCEIForModes(['reverse', 'memory']), inhibitoryControl: getBestCEIForModes(['inhibit']), cognitiveFlexibility: getBestCEIForModes(['switch']), visualSpatial: getBestCEIForModes(['memory']) }; const maxScore = Math.max(1, ...Object.values(scores)); const normalize = (score) => Math.round((score / maxScore) * 100); for(const key in scores) { scores[key] = normalize(scores[key]); } return scores; }
    getRecords() { return JSON.parse(localStorage.getItem('cognitiveRecordsV5') || '[]'); }
    saveRecord(stats) { const records = this.getRecords(); const date = new Date(); const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; records.push({ ...stats, date: formattedDate }); localStorage.setItem('cognitiveRecordsV5', JSON.stringify(records)); this.updateDashboard(); }
    clearRecords() { if (confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰è®­ç»ƒæ•°æ®ã€‚ç¡®å®šå—ï¼Ÿ')) { localStorage.removeItem('cognitiveRecordsV5'); this.updateDashboard(); } }
    getModeName(mode) { const names = {'standard': 'æ ‡å‡†', 'reverse': 'é€†åº', 'inhibit': 'æŠ‘åˆ¶', 'switch': 'åˆ‡æ¢', 'memory': 'è®°å¿†'}; return names[mode] || mode; }
    shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    playSound(sound) { if(sound) { sound.currentTime = 0; sound.play().catch(e => {}); } } 
    showMessage(text, type) { this.messageDiv.textContent = text; this.messageDiv.className = `message ${type}`; this.messageDiv.style.display = 'block'; }
    hideMessage() { this.messageDiv.style.display = 'none'; }
    startTimer() { this.timer = setInterval(() => { if (this.isGameActive && this.timeDisplay) this.timeDisplay.textContent = Math.floor((Date.now() - this.startTime) / 1000); }, 200); }
}

window.addEventListener('DOMContentLoaded', () => {
    try {
        new CognitiveTrainingApp();
    } catch(e) {
        console.error("Failed to initialize the training app:", e);
    }
});
</script>

</body>
</html>
